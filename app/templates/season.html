{% extends 'base.html' %}
{% block title %}Season Statistics - {{ stats.season }}{% endblock %}
{% block content %}
<h1>Season Statistics â€” {{ stats.season }}</h1>

<form method="get" action="{{ url_for('main.season_view') }}">
  <label for="season" class="form-label">Select Season:</label>
  <select name="season" id="season" class="form-select" style="max-width: 200px;" onchange="this.form.submit()">
    {% for s in stats.available_seasons %}
    <option value="{{ s }}" {% if s==stats.season %}selected{% endif %}>{{ s }}</option>
    {% endfor %}
  </select>
</form>

<h2>Summary</h2>
<div class="chart-container" style="position: relative; max-width: 300px; margin: 20px auto;">
  <canvas id="winLossChart"></canvas>
</div>
<div class="table-responsive">
  <table class="table table-sm" style="max-width: 500px;">
    <tr>
      <th>Total matches</th>
      <td>{{ stats.total_matches }}</td>
    </tr>
    <tr>
      <th>Wins</th>
      <td>{{ stats.wins }}</td>
    </tr>
    <tr>
      <th>Draws</th>
      <td>{{ stats.draws }}</td>
    </tr>
    <tr>
      <th>Losses</th>
      <td>{{ stats.losses }}</td>
    </tr>
    <tr>
      <th>Win %</th>
      <td>{{ '%.1f' % stats.win_pct }}%</td>
    </tr>
    <tr>
      <th>Points For</th>
      <td>{{ stats.points_for }}</td>
    </tr>
    <tr>
      <th>Points Against</th>
      <td>{{ stats.points_against }}</td>
    </tr>
    <tr>
      <th>Avg Points For</th>
      <td>{{ stats.avg_points_for }}</td>
    </tr>
    <tr>
      <th>Avg Points Against</th>
      <td>{{ stats.avg_points_against }}</td>
    </tr>
  </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<script nonce="{{ csp_nonce() if csp_nonce else '' }}">
  const ctx = document.getElementById('winLossChart');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Wins', 'Losses', 'Draws'],
      datasets: [{
        label: 'Match Outcomes',
        data: {{ [stats.wins, stats.losses, stats.draws] | tojson }},
    backgroundColor: [
      'rgba(40, 167, 69, 0.7)',
      'rgba(220, 53, 69, 0.7)',
      'rgba(255, 193, 7, 0.7)'
    ],
    borderColor: [
      'rgba(40, 167, 69, 1)',
      'rgba(220, 53, 69, 1)',
      'rgba(255, 193, 7, 1)'
    ],
    borderWidth: 1
  }]
      },
    options: {
    responsive: true,
    plugins: {
      legend: {
        position: 'top',
      }
    }
  }
    });
</script>

<h2>Players Used</h2>
<p><strong>Total players used:</strong> {{ stats.total_players_used }}</p>
<p><strong>Debuts:</strong> {{ stats.debut_count }} ({{ '%.1f' % stats.debut_pct }}%)</p>
<p><strong>Previous season:</strong> {{ stats.previous_season or 'N/A' }}</p>
<p><strong>Leavers:</strong> {{ stats.leavers_count }} ({{ '%.1f' % stats.leavers_pct }}%)</p>
{% if stats.leavers_count > 0 %}
<p><em>Leavers list:</em> {{ stats.leavers|join(', ') }}</p>
{% endif %}

<h2>Player Leaderboard</h2>
<div id="player-leaderboard">
  <input class="search form-control" placeholder="Search" />
  <br>
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th class="sort" data-sort="player">Player</th>
          <th class="sort" data-sort="starts">Starts</th>
          <th class="sort" data-sort="bench">Bench</th>
          <th class="sort" data-sort="total">Total</th>
        </tr>
      </thead>
      <tbody class="list">
        {% for name, counts in stats.leaderboard %}
        <tr>
          <td class="player"><a href="{{ url_for('main.player_view') }}?name={{ name|urlencode }}">{{ name }}</a></td>
          <td class="starts">{{ counts.starts }}</td>
          <td class="bench">{{ counts.bench }}</td>
          <td class="total">{{ counts.total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"
  integrity="sha512-tPy_M51goDsoXk/AeMKNjs2IeH7ifQ30Jv9p/p0o5C5d+9p/aor8f6ss6/oD/Gf/Q0a/V2agbJk2/vVd29X/Vw=="
  crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
<script nonce="{{ csp_nonce() if csp_nonce else '' }}">
  var options = {
    valueNames: ['player', 'starts', 'bench', 'total']
  };

  var playerLeaderboard = new List('player-leaderboard', options);
</script>

<h2>Shirt Number Distribution</h2>
<div class="table-responsive">
  <table class="table table-sm" style="max-width: 400px;">
    <thead>
      <tr>
        <th>Shirt #</th>
        <th>Count</th>
        <th>%</th>
      </tr>
    </thead>
    <tbody>
      {% for item in stats.shirt_dist %}
      <tr>
        <td>{{ item.num }}</td>
        <td>{{ item.count }}</td>
        <td>{{ '%.1f' % item.pct }}%</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h2>Matches</h2>
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Date</th>
        <th>Opposition</th>
        <th>Location</th>
        <th>Result</th>
        <th>GF</th>
        <th>GA</th>
      </tr>
    </thead>
    <tbody class="clickable-rows">
      {% for m in stats.match_list %}
      <tr data-href="{{ url_for('admin.edit_match', match_id=m.id) }}">
        <td>{{ m.date.strftime('%d/%m/%Y') }}</td>
        <td>{{ m.opposition }}</td>
        <td>{{ m.location }}</td>
        <td>{{ m.result }}</td>
        <td>{{ m.guildford_points if m.guildford_points is not none else 'N/A' }}</td>
        <td>{{ m.opposition_points if m.opposition_points is not none else 'N/A' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}