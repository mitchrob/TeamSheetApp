{% extends 'base.html' %}
{% block title %}Potential Duplicates{% endblock %}
{% block content %}
  <style>
    .duplicate-group {
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 24px;
      padding: 16px;
    }
    .duplicate-group h2 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    .player-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }
    .player-card {
      border: 1px solid #e0e0e0;
      padding: 12px;
      border-radius: 6px;
    }
    .player-card h3 {
      margin-top: 0;
    }
    .player-card ul {
      padding-left: 20px;
      margin: 0;
    }
    .actions {
      margin-top: 12px;
      border-top: 1px solid #eee;
      padding-top: 12px;
    }
  </style>

  <h1>Potential Duplicate Players</h1>
  <p>
    The following groups of players have very similar names and may be duplicates.
    Review each group and consider merging them by using the "Edit" functionality on the 
    <a href="{{ url_for('data_view') }}">Data page</a> to standardize the names.
  </p>

  {% if detailed_groups %}
    {% for group in detailed_groups %}
      <div class="duplicate-group">
        <h2>Group: {{ group|map(attribute='name')|join(', ') }}</h2>
        <div class="player-columns">
          {% for player_stats in group %}
            <div class="player-card">
              <h3>{{ player_stats.name }}</h3>
              <p>
                <strong>Total:</strong> {{ player_stats.total }} | 
                <strong>Starts:</strong> {{ player_stats.starts }} | 
                <strong>Bench:</strong> {{ player_stats.bench }}
              </p>
              <div class="actions">
                <form action="{{ url_for('merge_players') }}" method="post" onsubmit="return confirm('Are you sure you want to merge {{ player_stats.name }} into the selected player? This action cannot be undone.');">
                  <input type="hidden" name="source_name" value="{{ player_stats.name }}">
                  <select name="target_name">
                    <option value="">Merge into...</option>
                    {% for other_player in group %}
                      {% if other_player.name != player_stats.name %}
                        <option value="{{ other_player.name }}">{{ other_player.name }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn" style="width:auto; padding: 4px 8px;">Merge</button>
                </form>
                <form action="{{ url_for('ignore_pair') }}" method="post" style="margin-top: 8px;">
                    <input type="hidden" name="player1_name" value="{{ group[0].name }}">
                    <input type="hidden" name="player2_name" value="{{ group[1].name }}">
                    <button type="submit" class="btn secondary" style="width:auto; padding: 4px 8px;">Ignore This Pair</button>
                </form>
              </div>
              <strong>Appearances:</strong>
              <ul>
                {% for appearance in player_stats.appearances %}
                  <li>{{ appearance.match.date.strftime('%d/%m/%Y') }} vs {{ appearance.match.opposition }} - <a href="{{ url_for('edit_match', match_id=appearance.match.id) }}">Edit Match</a></li>
                {% endfor %}
              </ul>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No potential duplicates found with the current similarity threshold.</p>
  {% endif %}
{% endblock %}